{% extends "base.html" %}
{% load static %}
{% block content %}

{% url 'account_login' as login_url %}
{% url 'account_signup' as signup_url %}
{% url 'account_logout' as logout_url %}

</div>
<div id="juke-header">
    <h1>Loch Inn Juke Box</h1>
    {% if user.is_authenticated %}
    <div><a href="{% url 'account_logout' %}">Logout</a></div>
    {% else %}
    <div><a href="{% url 'account_login' %}">Login</a></div>
    <div><a href="{% url 'account_signup' %}">Sign Up</a></div>
    {% endif %}
</div>
<div id="juke-search" class="juke-container">
    <h2>Search</h2>
    <div>
        <input type="text" name="q" placeholder="Search for a song..." class="form-control" value="{{ query }}" />
        <a href="search/" class="btn btn-primary">Search</a>
    </div>
</div>
<div id="song-list">
    {% if songs %}
        {% for song in songs %}
        <div class="song-item">
            <p>{{ song.song_name }} by {{ song.artist_name }}</p>
            <form method="post" action="{% url 'add_to_local_list' song.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Add to Local List</button>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <p>No songs found matching "{{ query }}".</p>
    {% endif %}
</div>
<div id="juke-main" class="juke-container">
    <h1>Loch Inn Juke Box</h1>
    <div class="video-box">video</div>
    <h2>Coming Up Next...</h2>
    <div>
        {% for song in local_list %}
        â€¢ {{ song }}
        {% endfor %}
    </div>
</div>

<div id="juke-chat" class="juke-container">
    <h2>Live Chat</h2>
    <div>
        <center>
            <h1>Hello , Welcome to my chat site ! {{request.user}}</h1>
        </center>
        <br>
        {% if request.user.is_authenticated %}
        <center> Logout the chat Page <a href="{% url 'account_logout' %}">Logout</a></center>
        {% endif %}
        <div class="chat__item__container" id="id_chat_item_container" style="font-size: 20px">
            <br />
            <input type="text" id="id_message_send_input" />
            <button type="submit" id="id_message_send_button">Send Message</button>
            <br />
            <br />
        </div>
        <script>
           const chatSocket = new WebSocket(
                (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/"
            );
            chatSocket.onopen = function (e) {
                console.log("The connection was setup successfully !");
            };
            chatSocket.onclose = function (e) {
                console.log("Something unexpected happened !");
            };
            document.querySelector("#id_message_send_input").focus();
            document.querySelector("#id_message_send_input").onkeyup = function (e) {
                if (e.keyCode == 13) {
                    document.querySelector("#id_message_send_button").click();
                }
            };
            document.querySelector("#id_message_send_button").onclick = function (e) {
                var messageInput = document.querySelector(
                    "#id_message_send_input"
                ).value;
                chatSocket.send(JSON.stringify({ message: messageInput, username: "{{request.user.username}}" }));
            };
            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                var div = document.createElement("div");
                div.innerHTML = data.username + " : " + data.message;
                document.querySelector("#id_message_send_input").value = "";
                document.querySelector("#id_chat_item_container").appendChild(div);
            };
        </script>
    </div>
</div>

{% endblock %}